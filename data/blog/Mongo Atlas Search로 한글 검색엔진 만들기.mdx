---
title: 빠르게 검색 기능 만들 땐 Atlas Search
date: '2023-04-13'
tags: ['MongoDB', 'Atlas', 'MongoDB Atlas Search']
draft: false
summary: 'Atlas Search 기능으로도 초기 검색 기능 구현에는 전혀 무리가 없다!'
---

# 개요

최근에 회사에서 작은 토이 프로젝트를 진행하면서 검색 기능에 대한 요구사항이 있었는데, 간단하게 검색 기능을 구현하기 괜찮아서
올려본다.

1. 해당 검색 기능을 도입할 서비스는 회사 내부에서 진행된 간단한 프로젝트로 처음부터 고도화된 솔루션을 도입할 필요가 없다.
2. 앞으로 해당 프로젝트에 대한 유지보수를 최소화 할 것이므로 엘라스틱서치를 관리해야 하는 엔지니어가 투입되길 바라진 않았다.
3. 검색의 대상이 되는 데이터는 더 이상 갱신이 되지 않는 데이터다.
4. 간단하게 시범용으로 개발된 서비스기 때문에 비용은 항상 절약하는 방향이어야 한다.
5. 한글 지원이 되야 한다. 간편하면 더 좋다.

조건들을 따져봤을 때 나온 결론은 MongoDB Atlas에서 제공해주는 Search 기능을 활용하는 것이었다.

이를 통해 추가적인 이점도 얻을 수 있었는데 그 점들은 다음과 같다.

1. 몽고디비 데이터를 검색 엔진으로 저장하는 과정이 간단하다.
2. 아파치 Lucene을 사용한다. 이는 엘라스틱서치에서 쓰는 검색 라이브러리이며 엘라스틱서치만의 기능이 필요하지 않은 간단한 요구사항은 충분히 검증된
   라이브러리로 구현된다는 것을 말한다.
3. 아틀라스를 사용중이라면 무료나 마찬가지. M0 티어 데이터베이스도 갯수 제한이 있지만 Full Text 인덱스를 설정할 수 있다.

# Atlas Search

| ![MongoDB Atlas Search](https://www.mongodb.com/docs/atlas/images/fts-architecture.png) |
| :-------------------------------------------------------------------------------------: |
|                              몽고디비 아틀라스 서치의 구조                              |
|      출처: https://www.mongodb.com/docs/atlas/atlas-search/atlas-search-overview/       |

아틀라스 서치에 대해 설명하자면
아틀라스 서치는 데이터베이스 Fully Managed 서비스인 몽고디비 아틀라스에서 제공하는 전문 검색 기능으로
몽고디비 데이터를 검색하기 용이하게 해준다.
많은 개발자들이 검색 기능하면 엘라스틱 서치를 떠올릴 것으로 예상한다.
검색 기능하면 떠오르는 솔루션이 엘라스틱 서치인 것이다. 그 엘라스틱 서치가 `Apache Lucene` 기반을 기반으로 동작한다.
몽고디비 아틀라스 또한 `Lucene`을 기반으로 구현되었다. 이는 이미 널리 쓰이는 솔루션의 기반이 된 라이브러리를
사용하므로 안정성은 충분히 검증되었다고 본다.

몽고디비를 실행하게 되면 `mongod`라는 데몬 프로세스가 돌아간다. 해당 프로세스는 데이터 요청과 접근 관리등을 담당한다.
아틀라스 서치를 사용하게 되면 추가로 `mongot`라는 자바 웹 프로세스가 실행된다. 서치 기능은 이 `mongod`와 `mongot`
프로세스가 협력하여 처리되는 것이다. `mongot` 프로세스는 검색 인덱스가 설정된 도큐먼트들의 상태를 모니터링하고 변경 시 검색
인덱스를 갱신하고, `$search` 쿼리에 맞는 도큐먼트를 찾아 반환해준다.

전체적인 Search 기능의 플로우는 다음과 같다.

1. 클라이언트가 `$search` 파이프라인을 사용한 쿼리를 보낸다.
2. `mongod`는 해당 요청을 `mongot`로 전달한다.
3. `mongot`는 검색 인덱스를 사용해 쿼리에 맞는 도큐먼트의 `ObjectId` 목록을 `mongod` 프로세스로 반환한다.
4. `mongod` 프로세스는 `ObjectId` 목록에 매칭되는 도큐먼트들을 클라이언트에 응답으로 전송한다.

## 고려해야 할 점

`mongot` 프로세스는 기본적으로 검색 인덱스를 통해 쿼리를 처리하고 `mongod` 프로세스에서 해당 도큐먼트들의 데이터를
가져와 반환한다. 이는 서로 다른 프로세스가 통신하면서 오버헤드가 발생하기 때문에 성능에 문제가 생길 소지가 있다.
이를 해결하는데 도움을 주기 위한 기능이 `stored source`라고 한다. 해당 기능은 `ObjectId`만 저장된 검색 인덱스에 도큐먼트의 필드를 같이 저장함으로써
`mongod` 프로세스에서 도큐먼트 데이터를 가져오지 않아도 `mongot`의 검색 인덱스만으로 데이터까지 가져올 수 있어서
해당 오버헤드를 해결할 수 있다. 물론 장점만 있는건 아니고, 인덱스의 크기가 커지기 때문에 트레이드오프를 고려해야 한다.

## 한글 검색 기능

### 사전 조건

일단 한글 검색을 WAS에서 구현하려면 해당 서버의 언어를 MongoDB가 지원하는지 확인해야 한다.
공식 문서에 명시된 지원 언어 목록은 다음과 같다.

- C#
- Go
- Java
- Node.js
- Python

MongoDB 버전은 4.2 이상이어야 한다.

### 한글 형태소 분석시 사용

![nori](/static/images/nori.png)

기본 문자열 분석기는 한글 기준이 아니기 때문에 검색 인덱스 생성 결과가 맘에 안들 수 있다.
이 경우 `Lucene`의 문자열 분석기인 `nori`라는 한글 분석기를 대신 사용할 수 있고, 이는 엘라스틱 서치에서 공식 지원하는
분석기이기 때문에 검증은 충분히 됐다고 본다. `Atlas Search`또한 `Lucene` 기반이기 때문인지 해당 분석기를 옵션으로 지정하여 바로 사용할 수 있다.

# 레퍼런스

토이 프로젝트에서 사용해서 좀 더 심층적인 부분이나 다양한 기능들을 리뷰하진 못했는데, 인프런에서 랠릿 서비스에 좀 더 잘 적용하고 있는 것 같으니,
혹시 흥미가 생긴 분들은 인프런 기술 블로그에 [해당 글](https://tech.inflab.com/202211-mongodb-atlas-search/)을
봐도 좋을 것 같다. 간단하게 써보고 느낀 점은 엘라스틱 스택에 여러 기능과의 연계를 단기간 안에 고려하지 않고,
검색 대상이 몽고디비에 존재한다면 구축하는데 드는 자원이 적은 `Atlas Search`를 써보는 것도 충분히 좋을 것 같다.

# 참조

- https://www.mongodb.com/docs/atlas/atlas-search/atlas-search-overview/
- https://esbook.kimjmin.net/06-text-analysis/6.7-stemming/6.7.2-nori
