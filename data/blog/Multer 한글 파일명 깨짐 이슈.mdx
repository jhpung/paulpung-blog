---
title: Multer í•œê¸€ íŒŒì¼ëª… ê¹¨ì§
date: '2023-01-11'
tags: ['Multer', 'S3', 'Express', 'Node.js']
draft: false
summary: 'Mutler í•œê¸€ íŒŒì¼ëª…ì´ ê¹¨ì§€ëŠ” ì´ìŠˆ'
---

# ğŸ”” (2023.04.13) í•´ê²°ë°©ë²• ì¶”ê°€

## multerì˜ v1.4.5-lts.1 ë²„ì „ì—ì„œ ì˜ì¡´í•˜ê³  ìˆëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¬¸ì œë¡œ multer 1.4.4ì„ ì‚¬ìš©í•˜ë©´ í•´ê²°ëœë‹¤.

<details>
<summary>ì´ì „ í•´ê²° ë°©ë²•</summary>
## ì´ìŠˆ

`multer` ê¸°ë°˜ì˜ S3 íŒŒì¼ ì—…ë¡œë“œ íŒ¨í‚¤ì§€ì¸ `multer-s3`ë¥¼ ì‚¬ìš©í•´ í•œê¸€ íŒŒì¼ì„ ì—…ë¡œë“œ íŒŒì¼ëª…ì´ êº ì§€ëŠ” ì´ìŠˆê°€ ë°œìƒí–ˆë‹¤.

![ì´ë¯¸ì§€](/static/images/multer-files.png)

### ë°œìƒìƒí™©

ë¦¬ì•¡íŠ¸ë¡œ ë§Œë“  ì›¹ ì•±ì—ì„œ axiosë¡œ `multipart/form-data` íƒ€ì…ì˜ íŒŒì¼ ì—…ë¡œë“œ ìš”ì²­ì„ ë³´ë‚¼ ê²½ìš°, íŒŒì¼ëª…ì´ ê¹¨ì§€ëŠ” ì˜¤ë¥˜ ë°œìƒ

### ì‹œë„

1. axiosì˜ Content-Type í—¤ë” ê°’ì„ multipart/form-data; charset=utf8 ìœ¼ë¡œ ì„¤ì •í•´ì£¼ì—ˆë‹¤. ê·¸ëŸ¬ë‚˜ ë’¤ì— ì›ì¸ì„ ë³´ë©´ ë‚˜ì˜¤ì§€ë§Œ ì“¸ëª¨ ì—†ëŠ” ì§“ìœ¼ë¡œ íŒëª…
2. formì˜ _charset_ í•„ë“œë¥¼ `utf8`ìœ¼ë¡œ ì„¤ì •
   ì•„ë¬´ëŸ° ì˜í–¥ì´ ì—†ë‹¤.

### ì™œ ë°œìƒí–ˆë‚˜?

1. multerê°€ ì˜ì¡´í•˜ê³  ìˆëŠ” busboy íŒ¨í‚¤ì§€ê°€ íŒŒì¼ì˜ ê¸°ë³¸ charsetì„ `latin1`ìœ¼ë¡œ ì„¤ì •í•´ë†¨ë‹¤.
   > busboyëŠ” formdataë¥¼ ì²˜ë¦¬í•´ì£¼ëŠ” íŒ¨í‚¤ì§€ë‹¤.
2. multerëŠ” busboyì˜ charsetì„ ì„¤ì •í•  ìˆ˜ ìˆëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•˜ì§€ ì•ŠëŠ”ë‹¤. ì¦‰ multerë¥¼ ì‚¬ìš©í•˜ëŠ” ì•±ì€ charset ì„¤ì •ì„ ëª»í•œë‹¤.
3. axiosëŠ” `multipart/form-data` ìš”ì²­ì¼ ê²½ìš° Content-Typeì„ ì»¤ìŠ¤í…€í•  ìˆ˜ ì—†ë‹¤. ì¦‰, charset ì§€ì •ì´ ì•ˆëœë‹¤.

## í•´ê²°ë°©ì•ˆ

ë‹¤ìŒ ê¸€ì„ ì°¸ê³ í•˜ì—¬ ì„œë²„ì—ì„œ ì§ì ‘ charsetì„ ì§€ì •í•´ì£¼ëŠ” ë°©ì•ˆìœ¼ë¡œ í•´ê²°í–ˆë‹¤.

> [ì°¸ì¡°](https://github.com/expressjs/multer/issues/1104)

ê²°êµ­ì€ latin1ì„ ê¸°ë³¸ charsetìœ¼ë¡œ ì“°ë¯€ë¡œ ì„œë²„ì—ì„œ latin1ë¡œ ëœ ë¬¸ìì—´ì„ utf8ìœ¼ë¡œ ë³€í™˜ì‹œì¼œì£¼ë©´ ëœë‹¤.  
ë‹¤ë§Œ ì—¼ë ¤ë˜ëŠ” ê²ƒì€ í´ë¼ì´ì–¸íŠ¸ ìª½ì—ì„œ charsetì„ ì§€ì •í•´ì„œ ë³´ë‚´ì£¼ë©´ ê·¸ì— ë§ê²Œ ì„œë²„ì—ì„œ ì²˜ë¦¬í•˜ëŠ”ê²Œ ë” ì—¬ëŸ¬ ìƒí™©ì— ëŒ€ì‘í•˜ê¸° í¸í• ê±°ë¼ ìƒê°ì´ ë“ ë‹¤ëŠ” ê²ƒì´ë‹¤.

### ì½”ë“œ

- `diskStorage`ë¥¼ ì“°ëŠ” ê²½ìš°

  ```javascript
  const storage = multer.diskStorage({
    destination: function (req, file, cb) {
      cb(null, 'uploads') // íŒŒì¼ì´ ì €ì¥ë˜ëŠ” ê²½ë¡œì…ë‹ˆë‹¤.
    },
    filename: function (req, file, cb) {
      file.originalname = Buffer.from(file.originalname, 'latin1').toString('utf8')
      cb(null, file.originalname) // ì €ì¥ë˜ëŠ” íŒŒì¼ëª…
    },
  })
  ```

- `multer-s3`ë¥¼ ì“°ëŠ” ê²½ìš°

  ```javascript
  const storage = multerS3({
    // ...
    key: function (req, file, cb) {
      const now = dayjs()
      file.originalname = Buffer.from(file.originalname, 'latin1').toString('utf8')

      cb(
        null,
        /**
         * !í´ë”ë³„ë¡œ ìµœëŒ€ íŒŒì¼ ê°¯ìˆ˜ê°€ ìˆìŒ
         * => ë‚ ì§œë³„ë¡œ í´ë” ë¶„ë¦¬
         *  */
        file.originalname
      )
    },
    // ...
  })
  ```

## ê²°ë¡ 

ê°€ê¸‰ì  multer ì“°ì§€ ë§ì. 1ë…„ ë™ì•ˆ ë¬¸ì„œì™¸ì— ì—…ë°ì´íŠ¸ë„ ì—†ê³ , ì´ìŠˆ í•´ê²°ë„ ìŒ“ì—¬ê°€ëŠ” ê±¸ ë³´ë‹ˆ ì œëŒ€ë¡œ ê´€ë¦¬ê°€ ì•ˆë˜ê³  ìˆëŠ” ê²ƒ ê°™ë‹¤.

### ì˜ë¬¸

í¬ìŠ¤íŠ¸ë§¨ì´ ë¸Œë¼ìš°ì €ë‘ ë™ì‘ì´ ë‹¤ë¥´ë‹¤. í—¤ë”ì— charsetì„ ì§€ì •í•˜ì§„ ì•Šì•˜ëŠ”ë° ì„œë²„ ìª½ìœ¼ë¡œ ì˜¤ëŠ” íŒŒì¼ëª…ì´ `latin1`ì´ ì•„ë‹ˆë¼ `utf8`ìœ¼ë¡œ ì˜¨ë‹¤. í—¤ë” ê°’ìœ¼ë¡  ì›¹ì•±ì—ì„œ axiosë¡œ ë³´ë‚´ëŠ” ìš”ì²­ì˜ í—¤ë”í•˜ê³  ìœ ì˜ë¯¸í•œ ì°¨ì´ëŠ” ì—†ì–´ë³´ì´ëŠ”ë° ì¶”ê°€ë¡œ ì¡°ì‚¬ë¥¼ í•´ë´ì•¼ê² ë‹¤.

## 2023-01-12 ì¶”ê°€

Postmanì€ multipart/form-dataë¡œ ë³´ë‚¼ ë–„ ê° íŒŒíŠ¸ì— Content-Disposition í—¤ë”ì— UTF-8ìœ¼ë¡œ ëª…ì‹œí•´ë‘ì–´ì„œ UTF-8ìœ¼ë¡œ ë„˜ì–´ì˜¤ëŠ”ë°, axiosëŠ” ì„¤ì •ì´ ì•ˆë˜ì–´ ìˆì—ˆë‹¤.

| ![ì´ë¯¸ì§€](/static/images/multer-files-2.png) |
| :------------------------------------------: |
|             í¬ìŠ¤íŠ¸ë§¨ ìš”ì²­ ë©”ì‹œì§€             |

| ![ì´ë¯¸ì§€](/static/images/multer-files-3.png) |
| :------------------------------------------: |
|              axios ìš”ì²­ ë©”ì‹œì§€               |

ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„  axiosë¡œëŠ” ì•ˆë˜ê³  XMLHttpRequest APIë¥¼ ì‚¬ìš©í•˜ë©´ ê°€ëŠ¥í•œ ê²ƒ ê°™ì€ë° ì´ëŠ” ë„ˆë¬´ ì €ìˆ˜ì¤€ APIë¼ í”„ë¡ íŠ¸ì—”ë“œ ì—”ì§€ë‹ˆì–´ ë¶„ì´ ê³ í†µë°›ëŠ” ë°©í–¥ì´ ë ê±°ë¼ ìƒê°í–ˆë‹¤. ê·¸ë˜ì„œ ëŒ€ì‹ ì— mutlerë¥¼ forkí•´ì„œ ë¯¸ë“¤ì›¨ì–´ë¥¼ ë§Œë“¤ ë•Œ charsetë¥¼ ì¸ìë¡œ ì£¼ì…ê²Œë” í–ˆë‹¤.

multerì˜ /lib/make-middleware.js íŒŒì¼ ì¼ë¶€ë¶„ì´ë‹¤.

ë°‘ì˜ ì½”ë“œë¥¼

```javascript
try {
  busboy = Busboy({
    headers: req.headers,
    limits: limits,
    preservePath: preservePath,
  })
} catch (err) {
  return next(err)
}
```

ë‹¤ìŒê³¼ ê°™ì´ ë°”ê¿¨ë‹¤.

```javascript
try {
  busboy = Busboy({
    headers: req.headers,
    limits: limits,
    preservePath: preservePath,
    defParamCharset: charset, // ì¶”ê°€ëœ ë¶€ë¶„ - busboyëŠ” defParamCharsetì´ ì—†ìœ¼ë©´ ë°”ì´ë„ˆë¦¬ ë°ì´í„°ë¥¼ latin1ìœ¼ë¡œ ì¸ì‹í•¨
  })
} catch (err) {
  return next(err)
}
```

[ê¹ƒí—™ ë ˆí¬ì§€í† ë¦¬](https://github.com/jhpung/multer-utf8)

í•´ë‹¹ ì‘ì—…ì‚¬í•­ì€ ìœ„ ë ˆí¬ì§€í† ë¦¬ì— ìˆë‹¤.

npmì—ë„ ì˜¬ë ¤ë†¨ë‹¤.

[npm ë§í¬](https://www.npmjs.com/package/multer-utf8)

multer ì½”ë“œê°€ ë³µì¡í•˜ì§€ ì•Šì•„ì„œ ì°¸ê³  ì‚¼ì•„ íŒŒì¼ ì—…ë¡œë“œ ë¯¸ë“¤ì›¨ì–´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë§Œë“¤ì–´ë³¼ê¹Œ ìƒê°ì´ ë“ ë‹¤. ì•„ ê·¸ë¦¬ê³  ì´ì „ ë²„ì „ì—ì„œ í•´ê²°ì±…ìœ¼ë¡œ ì œì‹œí•œ

```javascript
file.originalname = Buffer.from(file.originalname, 'latin1').toString('utf8')
```

ìœ„ì™€ ê°™ì€ ì„ì‹œ ì½”ë“œëŠ” ì´ì œ í•„ìš”ì—†ë‹¤.

</details>
